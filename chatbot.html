<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Luna | Wellness Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Nunito:wght@600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#ffe6f0;
      --bg2:#fff5f9;
      --card:#fffafa;
      --accent:#ff8fb3;
      --accent-2:#ffb6c9;
      --text:#333;
      --muted:#666;
      --ring:#ffd6e5;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px 16px 86px; /* room for bottom nav */
    }
    .chat-container{
      width:100%;
      max-width:720px;                 /* bigger */
      height:90vh;                      /* taller */
      max-height:900px;
      background:var(--card);
      border-radius:20px;
      box-shadow:0 10px 30px rgba(255, 150, 180, .35);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border:1px solid #ffe3ed;
    }
    .chat-header{
      background:linear-gradient(90deg,#ff9dbd,#ffc1d6);
      color:#fff;
      padding:16px 20px;
      font-weight:700;
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .chat-header .brand{font-family:Nunito, Inter, sans-serif; font-size:1.2rem}
    .chat-header small{opacity:.9; font-weight:500}

    .chat-box{
      flex:1;
      overflow-y:auto;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      scroll-behavior:smooth;
    }
    .message{
      max-width:85%;
      padding:12px 14px;
      border-radius:16px;
      line-height:1.5;
      font-size:1rem;
    }
    .luna{
      align-self:flex-start;
      background:#ffd6e5;
      color:#222;
      border:1px solid #ffe3ed;
    }
    .user{
      align-self:flex-end;
      background:#fbeaf1;
      border:1px solid #ffe3ed;
    }
    .chat-input{
      display:flex;
      gap:10px;
      padding:12px;
      border-top:1px solid #ffe3ed;
      background:#fff0f7;
    }
    .chat-input input{
      flex:1;
      border:1px solid #ffd6e5;
      border-radius:22px;
      padding:12px 14px;
      font-size:1rem;
      outline:none;
    }
    .chat-input button{
      border:none;
      background:var(--accent);
      color:#fff;
      padding:12px 16px;
      border-radius:22px;
      font-weight:600;
      cursor:pointer;
      transition:.2s transform ease, .2s opacity ease;
    }
    .chat-input button:hover{transform:translateY(-1px); opacity:.95}

    .choice-row{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;
    }
    .chip{
      border:none; background:#ffe6ef; color:#333; padding:8px 12px; border-radius:20px; cursor:pointer;
      border:1px solid #ffd6e5; font-weight:600; font-size:.95rem;
    }
    .chip:hover{background:#ffe0ea}

    .recipe-title{
      font-weight:700; text-decoration:underline dotted; cursor:pointer;
    }
    .recipe-steps{
      display:none; margin-top:8px; padding:10px; background:#fff0f7; border:1px solid #ffe3ed; border-radius:12px; color:#444; font-size:.95rem;
    }

    /* bottom nav */
    .nav-bar{
      position:fixed; left:12px; right:12px; bottom:12px;
      background:rgba(255, 200, 215, .92);
      backdrop-filter:saturate(140%) blur(8px);
      display:flex; justify-content:space-around; align-items:center;
      padding:10px 12px; border-radius:16px;
      box-shadow:0 -6px 22px rgba(255, 150, 180, .25);
      border:1px solid #ffd6e5;
    }
    .nav-item{
      color:#fff; text-decoration:none; font-weight:700;
      padding:8px 10px; border-radius:12px; transition:.2s background ease;
    }
    .nav-item:hover{background:rgba(255,255,255,.18)}
    .nav-item.active{background:rgba(255,255,255,.25)}
  </style>
</head>
<body>

  <div class="chat-container">
    <div class="chat-header">
      <div class="brand">Luna</div>
      <small>Wellness chat</small>
    </div>

    <div id="chat" class="chat-box"></div>

    <div class="chat-input">
      <input id="input" type="text" placeholder="Type here…" />
      <button id="send">Send</button>
    </div>
  </div>

  <!-- shared bottom nav for all pages -->
  <nav class="nav-bar">
    <a class="nav-item" href="index.html">Home</a>
    <a class="nav-item active" href="chatbot.html">Luna</a>
    <a class="nav-item" href="account.html">Account</a>
  </nav>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    // pull user to greet by name if available
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const firstName = user.firstName || 'Friend';

    // state
    let recipes = {};
    let stage = 'idle';  // 'weight' | 'height' | 'pref' | 'done' | 'ask_new'
    let data = { weight:null, height:null, bmi:null, category:null, preference:null, plan:null };

    // ---------- UI helpers ----------
    const addMsg = (text, who='luna', isHTML=false) => {
      const m = document.createElement('div');
      m.className = `message ${who}`;
      m[isHTML ? 'innerHTML' : 'textContent'] = text;
      chat.appendChild(m);
      chat.scrollTop = chat.scrollHeight;
      return m;
    };
    const addChoices = (labels) => {
      const row = document.createElement('div');
      row.className = 'choice-row';
      labels.forEach(l => {
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = l;
        b.onclick = () => handleChoice(l);
        row.appendChild(b);
      });
      const wrap = addMsg('', 'luna', true);
      wrap.appendChild(row);
    };

    // ---------- data ----------
    async function loadRecipes(){
      try{
        const res = await fetch('recipes.json');   // must be same folder & exact name
        recipes = await res.json();
      }catch(e){
        addMsg("I couldn't load recipes. Please confirm the file is named 'recipes.json' and is in the same folder.", 'luna');
      }
    }

    // ---------- flow ----------
    async function start(){
      await loadRecipes();

      const saved = JSON.parse(localStorage.getItem('mealPlan') || 'null');

      if(saved){
        data.plan = saved;
        addMsg(`Welcome back, ${firstName}. I still have your last meal plan.`);
        addMsg('Would you like a new plan today?');
        addChoices(['Yes','No']);
        stage = 'ask_new';
      }else{
        greetFresh();
      }
    }

    function greetFresh(){
      addMsg(`Hi ${firstName}. I can build you a simple day plan and recipe steps.`);
      addMsg('What is your weight in pounds?');
      stage = 'weight';
    }

    function handleSend(){
      const txt = (input.value || '').trim();
      if(!txt) return;
      addMsg(txt, 'user');
      input.value = '';

      switch(stage){
        case 'weight': handleWeight(txt); break;
        case 'height': handleHeight(txt); break;
        case 'pref':   handlePrefFree(txt); break;
        case 'ask_new':
          // If they type instead of clicking chips
          if(/^\s*yes\s*$/i.test(txt)) return handleChoice('Yes');
          if(/^\s*no\s*$/i.test(txt))  return handleChoice('No');
          return unknown();
        default:
          unknown();
      }
    }

    function handleChoice(label){
      // normalize
      if(stage === 'ask_new'){
        if(label === 'Yes'){
          data = { weight:null, height:null, bmi:null, category:null, preference:null, plan:null };
          greetFresh();
        }else{
          showPlan(data.plan, false); // show existing
        }
        return;
      }
      if(stage === 'pref'){
        // preference chosen via chip
        if(label === 'Vegetarian' || label === 'High-Protein' || label === 'Low-Carb' || label === 'No Preference'){
          applyPreference(label);
        }else{
          unknown();
        }
      }
    }

    // ---------- stages ----------
    function handleWeight(txt){
      const w = parseFloat(txt);
      if(!Number.isFinite(w) || w <= 0) return addMsg('Please enter a valid number for weight (in pounds).');
      data.weight = w;
      addMsg('Thanks. What is your height in inches?');
      stage = 'height';
    }

    function handleHeight(txt){
      const h = parseFloat(txt);
      if(!Number.isFinite(h) || h <= 0) return addMsg('Please enter a valid number for height (in inches).');
      data.height = h;

      // BMI & category
      const bmi = (data.weight / (h*h)) * 703;
      data.bmi = Number(bmi.toFixed(2));

      // categories in your JSON: underweight, normal, overweight (no "obese")
      let cat = 'normal';
      if(bmi < 18.5) cat = 'underweight';
      else if(bmi < 25) cat = 'normal';
      else if(bmi < 30) cat = 'overweight';
      else cat = 'obese'; // we'll map obese->overweight when filtering
      data.category = cat;

      // gentle feedback
      let fb = `Your BMI is ${data.bmi}. `;
      if(cat === 'underweight') fb += 'Let’s focus on nourishing and adding healthy calories.';
      else if(cat === 'normal') fb += 'Great balance—let’s maintain with smart choices.';
      else if(cat === 'overweight') fb += 'Small improvements plus regular movement will help.';
      else fb += 'We’ll take steady steps with mindful meals and activity.';

      addMsg(fb);
      askPreference();
    }

    function askPreference(){
      addMsg('Any dietary preference? Choose one:');
      addChoices(['Vegetarian','High-Protein','Low-Carb','No Preference']);
      stage = 'pref';
    }

    function handlePrefFree(txt){
      // let typed values route same as chips
      const map = {
        'vegetarian':'Vegetarian',
        'high-protein':'High-Protein',
        'high protein':'High-Protein',
        'low-carb':'Low-Carb',
        'low carb':'Low-Carb',
        'no':'No Preference',
        'none':'No Preference',
        'no preference':'No Preference'
      };
      const key = txt.trim().toLowerCase();
      if(map[key]) applyPreference(map[key]);
      else unknown();
    }

    function applyPreference(label){
      data.preference = label; // store the display label
      buildPlan();
    }

    // ---------- recipes ----------
    function pick(mealType){
      const arr = recipes?.[mealType] || [];
      const pref = (data.preference || 'No Preference').toLowerCase(); // display label -> normalize
      // items are [name, steps[], categoryString, tags[]]
      // map obese->overweight to match your JSON categories
      const wantCat = (data.category === 'obese') ? 'overweight' : data.category;

      const filtered = arr.filter(([name, steps, cat, tags]) => {
        const catOk = (cat === wantCat) || (data.category === 'obese' && cat === 'overweight');
        if(pref === 'no preference') return catOk;
        // normalize tags
        const t = (tags || []).map(x => String(x).toLowerCase());
        return catOk && t.includes(pref);
      });
      if(!filtered.length) return null;
      return filtered[Math.floor(Math.random()*filtered.length)];
    }

    function buildPlan(){
      const plan = {};
      ['breakfast','lunch','snacks','dinner'].forEach(meal=>{
        plan[meal] = pick(meal) || [`Chef’s choice`, [], 'normal', []];
      });
      data.plan = plan;
      localStorage.setItem('mealPlan', JSON.stringify(plan));
      showPlan(plan, true);
      stage = 'done';
    }

    function showPlan(plan, isNew){
      addMsg(isNew ? 'Here is your plan for today:' : 'Here is your saved plan:');
      for(const [meal, rec] of Object.entries(plan)){
        const [name, steps] = rec;
        const wrap = addMsg(`${meal.toUpperCase()}: `, 'luna', true);
        const title = document.createElement('span');
        title.className = 'recipe-title';
        title.textContent = name;
        wrap.appendChild(title);

        const stepDiv = document.createElement('div');
        stepDiv.className = 'recipe-steps';
        stepDiv.innerHTML = (steps||[]).map(s => `• ${s}`).join('<br>');
        wrap.appendChild(stepDiv);

        title.addEventListener('click', ()=> {
          stepDiv.style.display = stepDiv.style.display === 'block' ? 'none' : 'block';
        });
      }

      // After showing plan on a return visit, offer a fresh one again
      if(!isNew){
        addMsg('Would you like a new plan now?');
        addChoices(['Yes','No']);
        stage = 'ask_new';
      }
    }

    // ---------- misc ----------
    function unknown(){
      addMsg("Sorry, I don't quite understand! I'm only used to give you recipes and plans to lose/add/maintain weight!");
    }

    // wire events
    sendBtn.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSend(); });

    start();
  </script>
</body>
</html>
